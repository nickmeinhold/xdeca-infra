services:
  kanbn:
    build:
      context: ./kan-source
      dockerfile: apps/web/Dockerfile
    image: kanbn:local
    container_name: kanbn
    restart: unless-stopped
    depends_on:
      - postgres
    environment:
      - NEXT_PUBLIC_BASE_URL=${KANBN_URL}
      - BETTER_AUTH_SECRET=${AUTH_SECRET}
      - POSTGRES_URL=postgres://kanbn:${POSTGRES_PASSWORD}@postgres:5432/kanbn
      - NEXT_PUBLIC_ALLOW_CREDENTIALS=true
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_SECURE=false
      - EMAIL_FROM=${SMTP_FROM_EMAIL}
      - TRELLO_APP_API_KEY=${TRELLO_API_KEY}
      - TRELLO_APP_API_SECRET=${TRELLO_API_SECRET}
      # S3/MinIO storage for attachments
      - S3_REGION=us-east-1
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_FORCE_PATH_STYLE=true
      - NEXT_PUBLIC_STORAGE_URL=${NEXT_PUBLIC_STORAGE_URL}
      - NEXT_PUBLIC_AVATAR_BUCKET_NAME=kanbn-avatars
      - NEXT_PUBLIC_ATTACHMENTS_BUCKET_NAME=kanbn-attachments
    ports:
      - "3003:3000"
    networks:
      - kanbn

  postgres:
    image: postgres:15-alpine
    container_name: kanbn_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=kanbn
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=kanbn
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - kanbn

volumes:
  postgres_data:

networks:
  kanbn:
